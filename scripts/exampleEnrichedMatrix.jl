using Revise
using LinearAlgebra  # Import the LinearAlgebra module
using SparseArrays
using EnrichedFiniteElements

const Transformations = EnrichedFiniteElements.TransformationFunctions
const integrator = EnrichedFiniteElements.Operators

const matrix_comp = EnrichedFiniteElements.MatrixCreation

const mesh_create = EnrichedFiniteElements.MeshCreation
const wave_func = EnrichedFiniteElements.EnrichmentCreator

#! Set up for the matrix creation
domain = ((0, 1), (0, 1))
num_nodes = 10

# Create the mesh
mesh = mesh_create.rectangle_domain(domain)

nodes = mesh.nodes
connectivity = mesh.connectivity
boundary_index = mesh.boundary_idx
boundary_edges = mesh.boundary_edges

wave_x = 1
wave_y = 1
ansatz_wave = wave_func.create_wavenumbers(wave_x, wave_y)
test_ansatz = wave_func.create_wavenumbers(wave_x, wave_y)
wavenumbers_ansatz, wavenumbers_test =
    wave_func.wavenumber_creation(ansatz_wave, test_ansatz, 1)

idx_wave_ansatz = collect(1:size(wavenumbers_ansatz, 1))
idx_wave_test = collect(1:size(wavenumbers_test, 1))

all_pairs = wave_func.generate_pairs(idx_wave_ansatz, idx_wave_test)
println(all_pairs)
idx_connectivity = collect(1:size(connectivity, 1))
result = wave_func.combine_wavenumber_with_all_nodes(all_pairs, connectivity)

wave_node_pairs = result
dt = 0.1
cell_sparse_zero_array_2 = matrix_comp.compute_sparse_mass_matrix(
    all_pairs,
    nodes,
    wave_node_pairs,
    wavenumbers_ansatz,
    wavenumbers_test,
    integrator,
    dt,
    dt,
    0.0,
)

# Assemble the final large matrix without loops
num_rows = size(cell_sparse_zero_array_2,1)
num_cols = size(cell_sparse_zero_array_2,2)
final_matrix = reduce(vcat, [reduce(hcat, [cell_sparse_zero_array_2[i, j] for j in 1:num_cols]) for i in 1:num_rows]);

exact_mat = [0.031250000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.007812500000000 0.000000000000000 0.000000000000000 0.007812500000000 0.000000000000000 0.015625000000000 0.000000000000000 0.000000000000000
0.000000000000000 0.023437500000000 0.000000000000000 0.000000000000000 0.005859375000000 0.005859375000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.011718750000000
0.000000000000000 0.000000000000000 0.029513875000000 0.000000000000000 0.000000000000000 0.007335062500000 0.007421875000000 0.000000000000000 0.000000000000000 0.000000000000000 0.014756937500000 0.000000000000000
0.000000000000000 0.000000000000000 0.000000000000000 0.024479166666667 0.000000000000000 0.000000000000000 0.006119791666667 0.006119791666667 0.012239583333333 0.000000000000000 0.000000000000000 0.000000000000000
0.007812500000000 0.005859375000000 0.000000000000000 0.000000000000000 0.037109375000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.012695312500000 0.000000000000000 0.010742187500000
0.000000000000000 0.005859375000000 0.007335062500000 0.000000000000000 0.000000000000000 0.036176195312500 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.012228722656250 0.010753035156250
0.000000000000000 0.000000000000000 0.007421875000000 0.006119791666667 0.000000000000000 0.000000000000000 0.036827265104167 0.000000000000000 0.010991757552083 0.000000000000000 0.012293840885417 0.000000000000000
0.007812500000000 0.000000000000000 0.000000000000000 0.006119791666667 0.000000000000000 0.000000000000000 0.000000000000000 0.037369791666667 0.010872395833333 0.012565104166667 0.000000000000000 0.000000000000000
0.000000000000000 0.000000000000000 0.000000000000000 0.012239583333333 0.000000000000000 0.000000000000000 0.010991757552083 0.010872395833333 0.053081614583333 0.009429258072917 0.009548619791667 0.000000000000000
0.015625000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.012695312500000 0.000000000000000 0.000000000000000 0.012565104166667 0.009429258072917 0.069704872916667 0.009592019791667 0.009798178385417
0.000000000000000 0.000000000000000 0.014756937500000 0.000000000000000 0.000000000000000 0.012228722656250 0.012293840885417 0.000000000000000 0.009548619791667 0.009592019791667 0.068229166666667 0.009809026041667
0.000000000000000 0.011718750000000 0.000000000000000 0.000000000000000 0.010742187500000 0.010753035156250 0.000000000000000 0.000000000000000 0.000000000000000 0.009798178385417 0.009809026041667 0.052821177083333
];
exact_mat= [-0.031249828557056+0.000103514031053im 0.000000000000000 0.000000000000000 0.000000000000000 -0.007812457139264+0.000025878507763im 0.000000000000000 0.000000000000000 -0.007812457139264+0.000025878507763im 0.000000000000000 -0.015624914278528+0.000051757015526im 0.000000000000000 0.000000000000000
0.000000000000000 -0.023437371417792+0.000077635523289im 0.000000000000000 0.000000000000000 -0.005859342854448+0.000019408880822im -0.005859342854448+0.000019408880822im 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 -0.011718685708896+0.000038817761645im
0.000000000000000 0.000000000000000 -0.029513713081740+0.000097763205543im 0.000000000000000 0.000000000000000 -0.007335022258569+0.000024297020397im -0.007421834282301+0.000024584582375im 0.000000000000000 0.000000000000000 0.000000000000000 -0.014756856540870+0.000048881602772im 0.000000000000000
0.000000000000000 0.000000000000000 0.000000000000000 -0.024479032369694+0.000081085990991im 0.000000000000000 0.000000000000000 -0.006119758092423+0.000020271497748im -0.006119758092423+0.000020271497748im -0.012239516184847+0.000040542995496im 0.000000000000000 0.000000000000000 0.000000000000000
-0.007812457139264+0.000025878507763im -0.005859342854448+0.000019408880822im 0.000000000000000 0.000000000000000 -0.037109171411504+0.000122922911875im 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 -0.012695242851304+0.000042052575115im 0.000000000000000 -0.010742128566488+0.000035582948174im
0.000000000000000 -0.005859342854448+0.000019408880822im -0.007335022258569+0.000024297020397im 0.000000000000000 0.000000000000000 -0.036175996843590+0.000119831801758im 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 -0.012228655567347+0.000040507020057im -0.010752976163226+0.000035618880482im
0.000000000000000 0.000000000000000 -0.007421834282301+0.000024584582375im -0.006119758092423+0.000020271497748im 0.000000000000000 0.000000000000000 -0.036827063063374+0.000121988437234im 0.000000000000000 -0.010991697249386+0.000036409636242im 0.000000000000000 -0.012293773439264+0.000040722720869im 0.000000000000000
-0.007812457139264+0.000025878507763im 0.000000000000000 0.000000000000000 -0.006119758092423+0.000020271497748im 0.000000000000000 0.000000000000000 0.000000000000000 -0.037369586649479+0.000123785528800im -0.010872336185476+0.000036014256637im -0.012565035232316+0.000041621266652im 0.000000000000000 0.000000000000000
0.000000000000000 0.000000000000000 0.000000000000000 -0.012239516184847+0.000040542995496im 0.000000000000000 0.000000000000000 -0.010991697249386+0.000036409636242im -0.010872336185476+0.000036014256637im -0.053081323368348+0.000175830140810im -0.009429206342364+0.000031233936415im -0.009548567406275+0.000031629316020im 0.000000000000000
-0.015624914278528+0.000051757015526im 0.000000000000000 0.000000000000000 0.000000000000000 -0.012695242851304+0.000042052575115im 0.000000000000000 0.000000000000000 -0.012565035232316+0.000041621266652im -0.009429206342364+0.000031233936415im -0.069704490503590+0.000230893836148im -0.009591967168175+0.000031773076306im -0.009798124630903+0.000032455966133im
0.000000000000000 0.000000000000000 -0.014756856540870+0.000048881602772im 0.000000000000000 0.000000000000000 -0.012228655567347+0.000040507020057im -0.012293773439264+0.000040722720869im 0.000000000000000 -0.009548567406275+0.000031629316020im -0.009591967168175+0.000031773076306im -0.068228792349572+0.000226005634465im -0.009808972227641+0.000032491898441im
0.000000000000000 -0.011718685708896+0.000038817761645im 0.000000000000000 0.000000000000000 -0.010742128566488+0.000035582948174im -0.010752976163226+0.000035618880482im 0.000000000000000 0.000000000000000 0.000000000000000 -0.009798124630903+0.000032455966133im -0.009808972227641+0.000032491898441im -0.052820887297154+0.000174967454875im
]

println(norm(cell_sparse_zero_array_2[end,end-1] - exact_mat))

using DelimitedFiles
using SparseArrays

# Load the data from the text file
data = readdlm("test/testdata/MassMatrixEnriched_noFrequencies.txt")

# Extract row indices, column indices, and values
rows = Int.(data[:, 1])
cols = Int.(data[:, 2])
vals = complex.(data[:, 3], data[:, 4])  # Combine real and imaginary parts

# Reconstruct the sparse matrix
Mass_matlab = sparse(rows, cols, vals);

println(norm(final_matrix - Mass_matlab))
 
